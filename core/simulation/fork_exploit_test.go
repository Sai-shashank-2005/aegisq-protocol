package simulation

import (
	"testing"

	"github.com/Sai-shashank-2005/aegisq-protocol/core/consensus"
)

func TestByzantineForkExploit(t *testing.T) {

	vs := consensus.NewValidatorSet()

	// 4 validators
	vs.AddValidator("v1", []byte("k1")) // honest
	vs.AddValidator("v2", []byte("k2")) // honest
	vs.AddValidator("v3", []byte("k3")) // byzantine
	vs.AddValidator("v4", []byte("k4")) // byzantine

	vp := consensus.NewVotePool(vs)

	view := 1
	hashA := "blockA"
	hashB := "blockB"

	// Honest v1 votes for blockA
	vp.AddVote(consensus.Vote{
		ValidatorID: "v1",
		BlockHash:   hashA,
		View:        view,
		Type:        consensus.Prepare,
	})

	// Honest v2 votes for blockB (network split simulation)
	vp.AddVote(consensus.Vote{
		ValidatorID: "v2",
		BlockHash:   hashB,
		View:        view,
		Type:        consensus.Prepare,
	})

	// Byzantine validators vote for BOTH blocks
	vp.AddVote(consensus.Vote{
		ValidatorID: "v3",
		BlockHash:   hashA,
		View:        view,
		Type:        consensus.Prepare,
	})
	vp.AddVote(consensus.Vote{
		ValidatorID: "v3",
		BlockHash:   hashB,
		View:        view,
		Type:        consensus.Prepare,
	})

	vp.AddVote(consensus.Vote{
		ValidatorID: "v4",
		BlockHash:   hashA,
		View:        view,
		Type:        consensus.Prepare,
	})
	vp.AddVote(consensus.Vote{
		ValidatorID: "v4",
		BlockHash:   hashB,
		View:        view,
		Type:        consensus.Prepare,
	})

	// Now check quorum
	aQuorum := vp.HasQuorum(hashA, view, consensus.Prepare)
	bQuorum := vp.HasQuorum(hashB, view, consensus.Prepare)

	if aQuorum && bQuorum {
		t.Fatal("FORK: quorum formed for two conflicting blocks")
	}
}